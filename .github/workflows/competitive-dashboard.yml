name: Update Competitive Analysis Dashboard

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install requests pyyaml

      - name: Fetch competitor stars
        id: fetch-stars
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime

          def get_repo_stars(owner, repo):
              """Fetch star count for a GitHub repository."""
              url = f"https://api.github.com/repos/{owner}/{repo}"
              headers = {
                  "Authorization": f"Bearer {os.environ.get('GITHUB_TOKEN', '')}",
                  "Accept": "application/vnd.github.v3+json"
              }
              try:
                  response = requests.get(url, headers=headers, timeout=10)
                  if response.status_code == 200:
                      return response.json().get("stargazers_count", 0)
              except Exception as e:
                  print(f"Error fetching {owner}/{repo}: {e}")
              return None

          # Competitors to track
          competitors = {
              "CrewAI": ("crewAIInc", "crewAI"),
              "Haystack": ("deepset-ai", "haystack"),
              "Probot": ("probot", "probot"),
              "MS Agent Framework": ("microsoft", "agent-framework"),
          }

          results = {}
          for name, (owner, repo) in competitors.items():
              stars = get_repo_stars(owner, repo)
              if stars is not None:
                  results[name] = stars
                  print(f"{name}: {stars:,} stars")
              else:
                  print(f"{name}: Unable to fetch stars")

          # Save results
          with open("/tmp/stars_data.json", "w") as f:
              json.dump({
                  "timestamp": datetime.utcnow().isoformat(),
                  "stars": results
              }, f, indent=2)

          print(f"\nData saved to /tmp/stars_data.json")
          EOF

      - name: Update dashboard
        run: |
          python - << 'EOF'
          import json
          import re
          from datetime import datetime
          from pathlib import Path

          # Load stars data
          stars_data = {}
          try:
              with open("/tmp/stars_data.json") as f:
                  data = json.load(f)
                  stars_data = data.get("stars", {})
          except Exception as e:
              print(f"Warning: Could not load stars data: {e}")

          # Read current dashboard
          dashboard_path = Path("docs/competitive-analysis.md")
          if not dashboard_path.exists():
              print("Dashboard file not found, skipping update")
              exit(0)

          content = dashboard_path.read_text()

          # Update timestamp
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
          content = content.replace(
              "<!-- LAST_UPDATED_PLACEHOLDER -->",
              timestamp
          )
          # Also handle if already updated
          content = re.sub(
              r"\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2} \d{2}:\d{2} UTC",
              f"**Last Updated:** {timestamp}",
              content
          )

          # Update stars section if we have data
          if stars_data:
              def format_stars(count):
                  if count >= 1000:
                      return f"{count:,}"
                  return str(count)

              # Build new stars table
              stars_table = "| Project | Stars | Trend |\n"
              stars_table += "|---------|-------|-------|\n"

              # Sort by stars descending
              sorted_competitors = [
                  ("CrewAI", "https://github.com/crewAIInc/crewAI"),
                  ("Haystack", "https://github.com/deepset-ai/haystack"),
                  ("Probot", "https://github.com/probot/probot"),
                  ("MS Agent Framework", "https://github.com/microsoft/agent-framework"),
              ]

              for name, url in sorted_competitors:
                  if name in stars_data:
                      stars = stars_data[name]
                      trend = "ðŸ“ˆ Growing" if stars > 1000 else "ðŸš€ New"
                      stars_table += f"| [{name}]({url}) | {format_stars(stars)} | {trend} |\n"

              # Add our project
              stars_table += "| [Agentic Chain](https://github.com/skills/integrate-mcp-with-copilot) | Growing | ðŸš€ New |\n"

              # Replace stars section
              pattern = r"<!-- STARS_SECTION_START -->.*?<!-- STARS_SECTION_END -->"
              replacement = f"<!-- STARS_SECTION_START -->\n{stars_table}<!-- STARS_SECTION_END -->"
              content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          # Write updated dashboard
          dashboard_path.write_text(content)
          print(f"Dashboard updated at {timestamp}")
          EOF

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet docs/competitive-analysis.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/competitive-analysis.md
          git commit -m "ðŸ“Š Weekly competitive analysis update"
          git push

      - name: Summary
        run: |
          echo "## ðŸ“Š Competitive Analysis Dashboard Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/stars_data.json ]; then
            echo "### Competitor Stars" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat /tmp/stars_data.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dashboard update complete" >> $GITHUB_STEP_SUMMARY
